# 스마트 컨트랙트와 EVM

### **스마트 컨트랙트와 EVM의 동작 원리**

전통적인 Web2 환경에서 "브라우저에 `google.com`을 입력했을 때 발생하는 과정"을 이해하는 것은 네트워크와 서버 동작의 핵심을 파악하는 기준이 됩니다. 이와 마찬가지로, Web3 환경에서는 사용자가 DApp과 상호작용할 때 발생하는 트랜잭션의 생명 주기를 이해하는 것이 블록체인 애플리케이션의 근간을 이해하는 핵심입니다.

본 자료는 아래의 핵심 질문을 통해 스마트 컨트랙트와 EVM의 역할을 포함한 이더리움의 전체적인 동작 흐름을 단계별로 분석합니다.

> 핵심 질문: "NFT 민팅(Mint) 버튼 클릭 시, 어떤 과정을 거쳐 해당 NFT가 사용자 지갑에 기록되는가?"
> 

이 질문에 대한 답을 따라가는 과정은 이더리움의 상태(State)가 어떻게 변경되고 기록되는지에 대한 심층적인 이해를 제공합니다.

---

### **1단계: 트랜잭션 생성 및 서명 (사용자 지갑)**

사용자가 DApp에서 특정 기능(예: Mint)을 실행하면, 연결된 지갑(예: MetaMask)은 블록체인에 기록할 **트랜잭션(Transaction)** 을 생성합니다. 트랜잭션은 이더리움의 상태를 변경하기 위한 유일한 수단이며, 다음과 같은 주요 정보로 구성됩니다.

- **`from`**: 트랜잭션을 발생시키는 외부 소유 계정(EOA)의 주소.
- **`to`**: 트랜잭션의 수신자 주소. NFT 민팅의 경우, 해당 **NFT 스마트 컨트랙트의 주소(CA)** 가 됩니다.
- **`data`**: 실행할 코드를 담고 있는 영역. 스마트 컨트랙트의 특정 함수를 호출하기 위한 정보(예: `mint()` 함수 호출)가 포함됩니다.
- **`gasLimit`**: 해당 트랜잭션 처리에 사용할 가스(Gas)의 최대 한도.
- **`maxFeePerGas` / `maxPriorityFeePerGas`**: 가스 단위당 지불할 의사가 있는 최대 수수료.
- **`nonce`**: `from` 주소에서 보낸 트랜잭션의 순차적 번호로, 이중 지불 공격을 방지합니다.
- **`signature`**: 사용자의 **개인키(Private Key)** 로 위의 정보들을 서명한 값. 이 서명은 해당 트랜잭션이 `from` 주소의 소유자에 의해 승인되었음을 증명합니다.

이 단계는 사용자가 자신의 자산을 사용하여 특정 계약을 실행하는 데 동의했음을 암호학적으로 증명하는 과정입니다.

---

### **2단계: 트랜잭션 전파 (이더리움 네트워크)**

서명된 트랜잭션은 사용자의 지갑과 연결된 **이더리움 노드(Node)** 로 전송됩니다. 노드는 이더리움 네트워크의 참여자로서, 블록체인 데이터의 사본을 저장하고 네트워크 규칙의 유효성을 검증하는 컴퓨터입니다.

1. **멤풀(Mempool) 추가**: 노드는 수신한 트랜잭션의 유효성(서명, 논스 등)을 1차적으로 검증한 후, 아직 블록에 포함되지 않은 트랜잭션들의 대기 공간인 **멤풀(Mempool)** 에 추가합니다.
2. **네트워크 전파**: 해당 트랜잭션은 P2P(Peer-to-Peer) 프로토콜을 통해 이웃 노드들에게 신속하게 전파되며, 이 과정이 반복되어 전체 네트워크가 새로운 트랜잭션의 존재를 인지하게 됩니다.

---

### **3단계: 트랜잭션 실행 (스마트 컨트랙트와 EVM)**

블록 생성자(Validator)는 멤풀에서 가스 수수료가 높은 트랜잭션을 선택하여 새로운 블록에 포함시키고, 이를 실행하여 블록체인의 상태를 업데이트합니다. 이 '실행'의 핵심적인 역할을 하는 것이 바로 **EVM(Ethereum Virtual Machine)** 입니다.

### **스마트 컨트랙트 (Smart Contract)**

- **정의**: 블록체인 상에 배포된 프로그램으로, 특정 조건이 충족될 경우 사전에 정의된 코드를 자동으로 실행합니다. 한번 배포된 코드는 수정이 불가능하며, 실행 결과는 모든 네트워크 참여자에게 투명하게 공유됩니다.
- **비유**: 자판기와 유사합니다. 정해진 금액(조건)을 투입하고 버튼(함수 호출)을 누르면, 약속된 상품(결과)이 반드시 나오는 것과 같이 결정론적으로 동작합니다. NFT 컨트랙트의 경우, `mint()` 함수는 "민팅 비용을 받고 호출자에게 새로운 토큰 소유권을 부여한다"는 규칙을 담고 있습니다.

### **이더리움 가상 머신 (EVM, Ethereum Virtual Machine)**

- **정의**: 스마트 컨트랙트 코드를 실행하기 위한 격리된 샌드박스 형태의 가상 실행 환경입니다. 모든 이더리움 노드는 동일한 EVM을 내장하고 있습니다.
- **역할**:
    1. 트랜잭션의 `to` 주소에 해당하는 스마트 컨트랙트의 코드(Bytecode)를 로드합니다.
    2. 트랜잭션의 `data` 필드를 해석하여 호출 대상 함수를 식별하고 실행합니다.
    3. 코드 실행 결과에 따라 컨트랙트의 내부 **상태(State)**를 변경합니다. (예: NFT 소유권 정보를 담은 `mapping` 변수의 값을 업데이트)
    4. 실행에 소모된 연산량만큼의 **가스(Gas)** 를 트랜잭션 발생자의 계정에서 차감합니다.

EVM의 가장 중요한 특징은 **결정론적(Deterministic) 실행**입니다. 동일한 입력값(트랜잭션)에 대해 모든 노드의 EVM은 항상 동일한 결과(상태 변경)를 출력하며, 이는 네트워크 전체가 단일한 상태에 합의할 수 있는 기반이 됩니다.

---

### **4단계: 상태 변경의 확정 및 기록 (블록체인)**

EVM에 의해 실행된 트랜잭션들의 결과, 즉 **상태 변경(State Transition)** 내역은 새로운 블록에 담깁니다.

1. **블록 전파 및 검증**: 생성된 블록은 네트워크의 다른 모든 노드에게 전파됩니다. 각 노드는 해당 블록에 포함된 모든 트랜잭션을 독립적으로 재실행하여 블록 생성자가 제시한 상태 변경 결과가 유효한지 검증합니다.
2. **합의 및 연결**: 대다수의 노드가 블록의 유효성에 동의하는 **합의(Consensus)** 과정이 완료되면, 해당 블록은 기존 블록체인의 마지막에 연결됩니다.
3. **영구 기록**: 블록체인에 한번 연결된 데이터는 사실상 수정이 불가능(Immutable)합니다. 이제 NFT의 소유권이 사용자에게 이전되었다는 사실은 전 세계에 분산된 원장에 영구적으로 기록된 것입니다.

DApp이나 NFT 마켓플레이스는 블록체인에 기록된 이 데이터를 조회하여 사용자에게 NFT 소유 현황을 시각적으로 보여줍니다.

---

### **요약: Web2 요청과 Web3 트랜잭션 흐름 비교**

| 구분 | Web2: `google.com` 요청 | Web3: NFT 민팅 트랜잭션 |
| --- | --- | --- |
| **요청 주체** | 브라우저 (HTTP Request) | 사용자 지갑 (Signed Transaction) |
| **전달 매체** | 인터넷 (TCP/IP, DNS) | 이더리움 P2P 네트워크 (Mempool) |
| **실행 환경** | 중앙 서버 (CPU, 웹서버) | 이더리움 노드 (EVM) |
| **실행 로직** | 서버사이드 코드 (e.g., Python, Java) | **스마트 컨트랙트** (e.g., Solidity) |
| **데이터 저장소** | 중앙화된 데이터베이스 (e.g., MySQL) | **블록체인 (분산 원장)** |
| **신뢰 기반** | 서비스 제공 기업 (e.g., Google) | 암호학적 증명 및 네트워크 합의 |